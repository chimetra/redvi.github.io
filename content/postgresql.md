Title: Настройка PostgreSQL для Django
Date: 2013-01-19 09:35
Tags: Server, Django
Slug: postgresql
Author: redVi
Summary: Об установке python и django мы уже говорили. Но зачастую для полноценной работы в django нужно взаимодействие с той или иной СУБД.

Об установке python и django мы уже говорили. Но зачастую для полноценной работы в django нужно взаимодействие с той или иной СУБД. В частности  когда вы создаёте приложение командой `startapp`, в новом каталоге появляется файл для представления ваших будущих моделей - `models.py` - который призван взаимодействовать с базой данных. На основе моделей, представленных в этом файле, и формируется наша база данных. Главный вопрос: какую СУБД выбрать? Это сугубо личное дело каждого разработчика, но в приведённом примере используется PostgreSQL. Обратимся к настройкам.

##I. Установка и настройка PostgreSQL

Сначала установим саму СУБД:

    :::console
    $ su
    # pacman -S postgresql

Создадим конфигурационный файл `postgresql.conf`, отведём место для хранения данных - `date` -  и изменим права доступа для этого хранилища так, чтобы они принадлежали пользователю нашей СУДБ, а именно - postgres:

    :::console
    # systemd-tmpfiles --create postgresql.conf
    # mkdir /var/lib/postgres/data
    # chown -c postgres:postgres /var/lib/postgres/data
    изменён владелец «/var/lib/postgres/data» с root:root на postgres:postgres

Последний штрих: от имени пользователя postgre запустим базу данных. Чтобы сделать упор на то, от имени какого пользователя производятся действие (это важно!), введём небольшое цветовое различие для команд.

    :::console
    $ su root
    # su - postgres
    [postgres@linux ~]$ initdb -D '/var/lib/postgres/data'
      Файлы, относящиеся к этой СУБД, будут принадлежать пользователю "postgres". От его имени также будет запускаться процесс сервера. Кластер баз данных будет инициализирован с локалью "ru_RU.UTF-8". Кодировка БД по умолчанию, выбранная в соответствии с настройками: "UTF8". Выбрана конфигурация текстового поиска по умолчанию "russian".

Теперь можно стартовать Postgre:

    :::console
    # systemctl start postgresql


##II. Создание базы данных

Следующим шагом будет собственно создание самой базы данных для наших скромных нужд. Пожалуй, следовало бы создать отдельного пользователя под конкретную базу данных, а при создании БД сразу указать нужную кодировку. Не забывайте, действуем от имени пользователя postgres!

    :::console
    [postgres@linux ~]$ createuser redvi
    [postgres@linux ~]$ createdb -O redvi myBD --encoding=UTF-8

В приведённом выше примере мы создали пользователя без каких-либо привелегий и даже без пароля. Чтобы поступить иначе, используйте соответствующие ключи с командой `createuser`:

- `-D` Пользователь не может создавать базы данных
- `-R` Пользователь не может создавать аккаунты
- `-S` Пользователь не является суперпользователем
- `-P` Запрашивать пароль при создании

Также была создана база данных `myBD` с кодировкой UTF-8
Подробнее:

    > createdb --help

Войдём в нашу базу данных и осмотримся:

    > [postgres@linux ~]$ psql myBD
      psql (9.2.2) Введите "help", чтобы получить справку.
      myBD-# => \c myDB Вы подключены к базе данных "myBD" как пользователь "postgres"
      myBD-# => \du
      Список ролей  Имя роли |   Атрибуты     | Член ролей
      ----------+------------------------------------+------------
      postgres | Суперпользователь, Создаёт роли, Создаёт БД, Репликация | {}  redvi

Выход из базы данных: `\q`

В последующем вы сможете заходить в базу данных под именем вновь созданного пользователя с помощью команды `psql myDB`

,где myDB - имя вашей базы данных.

##III. Установка библиотеки python для PostgreSQL, создание проекта

Для связывания django и PostgreSQL нам потребуется установить psycopg - так называемый адаптер. Лучше выбрать `psycopg` версии 2:

    :::console
    $ sudo pacman -S python-psycopg2
    $ mkdir myproject && cd myproject
    $ /usr/bin/django-admin.py startproject mysite

Можете вернуться на директорию выше и сразу просмотреть содержимое проекта.

    :::console
    $ tree myproject

Попробуем соединиться с нашей базой данных. если в выводе не будет ошибок, вы всё сделали правильно. При возникновении ошибок не ленитесь просматривать их вывод, он очень информативен и наверняка подскажет вам, где затаилась проблема.

    :::console
    $ python manage.py shell
      >>> from django.db import connection
      >>> cursor = connection.cursor()

Отлично. Теперь создадим приложение и свяжем PostgreSQL с django  посредством настроек последнего.
Создаём приложение:

    :::console
    $ python manage.py startapp books

Правим настройки. Если пароль пользователя БД не задан, просто оставьте соответствующее поле пустым:

    :::python
    # mysite/settings.py:
      DATABASES = {
           'default': {
                    'ENGINE': 'django.db.backends.postgresql_psycopg2',
                    'NAME': 'myDB',
                    'USER': 'redvi',
                    'PASSWORD': '',
                    'HOST': '',
                    'PORT': '',
                    }
                  }

Создаём нужные модели в `models.py`, после чего проверяем правильность всех настроек:

    :::console
    $ python manage.py validate

Инициализируем таблицы БД:

    :::console
    $ python manage.py sqlall books
      BEGIN;
      CREATE TABLE "books_author" (
      "id" serial NOT NULL PRIMARY KEY,
      "first_name" varchar(30) NOT NULL,
      "last_name" varchar(40) NOT NULL,
      "email" varchar(75) NOT NULL
      )
      ;

Готово!
