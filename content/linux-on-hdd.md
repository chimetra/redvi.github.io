Title: Переносим linux на внешний HDD
Date: 2011-12-30 08:25
Tags: Arch, Linux
Slug: linux-on-hdd
Author: redVi
Summary: Наверное, лучшее, что есть в linux - это его гибкость. Linux можно установить как на новое (с небольшими оговорками) железо, так и на старый Pentium III, который валяется у вас на балконе.

Наверное, лучшее, что есть в linux &mdash; это его гибкость. Linux можно установить как на новое (с небольшими оговорками) железо, так и на старый Pentium III, который валяется у вас на балконе. Хуже того, возможна установка  и даже просто копия работающей системы на внешний жёсткий диск. Чем, собственно, мы сегодня и займёмся.
Здесь представлен алгоритм действий, которые помогут сделать копию системы. Все тайные действа проводились на имеющемся в наличии ноутбуке с установленным ArchLinux, хотя надо отметить, что дистрибутив не имеет значения. Конечно, можно осуществить и обратное &mdash; клонировать настроенную, работающую систему с тестового внешнего диска на основной. Итак, поехали:

###I. Загружаемся с live-usb, live-cd.

Проверяем командой `fdisk -l` имеющиеся диски, разделы и то, как они отображаются. После чего при помощи `cfdisk` создаём необходимые разделы на диске, куда будут заливаться данные. В примере и далее это разделы `/` и `/home`, на внешний HDD.


###II. Создание файловых систем на только что созданных разделах:

    :::console
    # mkfs.ext4 /dev/sdb1  - это под корень
    # mkfs.ext4 /dev/sdb5 - это под /home

Раздел подкачки не создавался. Ваша разметка может быть иной.


###III. Монтирование всех разделов. Как это может выглядеть:

    :::console
    # mkdir /mnt/arch - создание каталога для монтирования корня основной системы
    # mkdir /mnt/arch/home - создание каталога для монтирования /home основной системы
    # mkdir /mnt/backup - создание каталога для монтирования корня на hdd
    # mkdir /mnt/backup/home - создание каталога для монтирования /home на hdd
    # mount /dev/sda1 /mnt/arch - непосредственно монтирование
    # mount /dev/sdb1 /mnt/backup - и внешний диск


###IV. Копирование содержимого основной системы на hdd. Примерно так:

    :::console
    # cd /mnt
    # cp -ax  bin/ dev/  lib64/ media/ opt/ sbin/ srv/ var/ boot/ etc/ lib/ sys/ usr/ /mnt/backup

То же самое с домашней директорией `/mnt/arch/home`

Если желаете наблюдать за процессом, добавьте ключ `-v`


###V. Внесение правок

Правим `/etc/fstab` и `/boot/grub/menu.lst` в `/mnt/backup`

Можно отмонтировать корневые разделы и повторить это с `/home`.

###VI. Установка загрузчика

Примонтировать разделы `/` и `/boot`, если `/boot` на отдельном разделе, чрутнуться в склонированную систему и установить загрузчик:

    :::console
    # mount /dev/sdb1 /mnt/backup
    # mount -t proc none /mnt/backup/proc
    # chroot /mnt/backup /bin/bash
    # grub
    # root (hd1,0)
    # setup (hd1)

Куда вы будете устанавливать загрузчик вам виднее, с приведённым в примере (hd1) это может не совпадать.
Загружаемся с внешнего диска, если правильно отредактировали выше указанные файлы и установили загрузчик, должно работать.
На этом всё.

*Кстати:* при правке `grub` и `/etc/fstab` гораздо удобнее пользоваться метками дисков. Для назначения меток следует воспользоваться  командой `e2label`:

    :::console
    # e2label /dev/sda1 new_label
    $ cat /etc/fstab
    LABEL=unix-boot  /boot ...
    LABEL=unix-root  /     ...
    LABEL=unix-home  /home ...
    $ cat /boot/grub/menu.lst
    ...
    kernel /boot/vmlinuz-XXX root=/dev/ram0 real_root=LABEL=unix-root
    ...

<b>P.S.</b> Arch-специфично: в `HOOKS` файла `/etc/mkinitcpio.conf` должен быть прописан `usb`, если его нет, придётся добавить и пересобрать initramfs.

