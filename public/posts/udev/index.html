<!DOCTYPE html>
<html lang="ru">
<head>

  <title>Udisks, udev и все-все-все | UNIX-LAB.ORG</title>
  <meta name="description" content="На кону тема монтирования файловых систем: локальных и сетевых. В процессе рассуждения будут затронуты общие положения, вспомогательные программы, ну и, собственно, настройки оных.">

  <meta charset="utf-8">
  <meta name="author" content="redVi">
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
  <link rel="icon" href="http://www.unix-lab.org/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="http://www.unix-lab.org/favicon.ico" type="image/x-icon">
  <link href="http://www.unix-lab.org/assets/stylesheets/screen.css" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/atom+xml" title="UNIX-LAB.ORG" href="http://www.unix-lab.org/feeds/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="UNIX-LAB.ORG" href="http://www.unix-lab.org/feeds/rss.xml">
</head>
<body>
<div id="outer-wrapper">
<div id="header-wrapper">
    <a href="/"><div class="logo"></div></a>
    <div class="small">блог об операционных системах, open source и программировании</div>
<div class="nav">
  <ul>
    <li><a href="/archive/">Архив</a></li>
    <li><a href="/about/">О блоге</a></li>
    <li><a href="/author/">Автор</a></li>
  </ul>
</div>
</div>

<div id="main">
<h2>Udisks, udev и все-все-все</h2>
<h5><i class="icon-feather"></i> 18 мая 2013

 <i class="icon-bookmarks"></i>

<a href="/tags/gentoo.html">Gentoo /</a>

<a href="/tags/linux.html">Linux /</a>

</h5>

<p>На кону тема монтирования файловых систем: локальных и сетевых. В процессе рассуждения будут затронуты общие положения, вспомогательные программы (21 век на дворе, не ручками же монтировать), ну и, собственно, настройки оных. Сразу надо оговориться, что пост вряд ли будет интересен с практической точки зрения линуксоидам, сидящим под Ubuntu или Fedora. В user-friendly дистрибутивах это работает «из коробки». Пользователи gentoo или arch linux вполне могут потратить несколько минут на чтение, чтобы настроить то, что ещё не настроено или поправить то, что работает не так, как хочется.</p>

<h2 id="toc_0">Конфигурация ядра</h2>

<p>Некоторые из утилит, которые будут настраиваться, потребуют включения в ядре особенных опций. В частности udisks2 желает, чтобы был включен swap-раздел, активирована <code>FUSE</code> и <code>USB autosuspend</code>.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">General setup  ---&gt;
    [*]Support for paging of anonymous memory (swap)
File systems
    &lt;*&gt;FUSE (Filesystem in Userspace) support
Device Drivers  ---&gt;
    [*] USB support  ---&gt;
    &lt;*&gt;Support for Host-side USB
    [*]USB runtime power management (autosuspend) and wakeup
File Systems --&gt;
    Pseudo filesystems  ---&gt;
        -*- Tmpfs virtual memory file system support (former shm fs)
        [*]Tmpfs POSIX Access Control Lists
    Native Language Support --&gt;
        &lt;*&gt; NLS UTF8
</code></pre></div>
<p>Проверить наличие или отсутствие опций можно при помощи команды <code>zcat</code>, вот так:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">$</span> zcat /proc/config.gz | grep что_изволите
</code></pre></div>
<p>Убедившись, что нужные опции присутствуют или же собрав ядро с ними, можно приступать к следующему пункту: установке приложений.</p>

<h2 id="toc_1">Установка приложений</h2>

<p>Прежде всего стоило бы установить <code>udev</code> или его аналог <code>eudev</code> (только для gentoo). Udev — менеджер устройств для новых версий ядра Linux, являющийся преемником devfs, hotplug и HAL. Его основная задача — обслуживание файлов устройств  в каталоге <code>/dev</code> и обработка всех действий, выполняемых в пространстве пользователя при добавлении/отключении внешних устройств, включая загрузку firmware;</p>

<p>Далее <code>fuse</code>  —   позволяет пользователям без привилегий создавать их собственные файловые системы без необходимости переписывать код ядра;</p>

<p><code>udisks2</code>  — D-Bus-интерфейс и соответствующий демон для управления накопителями, как съемными, так и, например, жесткими дисками;</p>

<p><code>curlftpfs</code>  —  позволяет монтировать каталоги с ftp-серверов;</p>

<p><code>sshfs-fuse</code>  —  позволяет управлять файлами с SFTP;</p>

<p><code>util-linux</code> — просто в обязательном порядке, утилиты, отвечающие за возможность монтирования в принципе;</p>

<p><code>udevil</code> — позволит монтировать каталоги с ftp-серверов при помощи графических приложений. Иными словами: открыли файловый менеджер, вписали адрес сервера, получили список каталогов, которые он содержит.</p>

<p>Такая возможность поддерживается не всеми файловыми менеджерами.</p>

<p>Теперь неплохо было бы сразу рассмотреть возможные опции  монтирования, дабы знать, когда и что именно нам может пригодиться.</p>

<p><b>-t</b>  —  указание на тип файловой системы</p>

<p><b>-o</b>  —  указание на специальную опцию монтирования</p>

<p><b>-a</b>  —  смонтировать все файловые системы, прописанные в <code>/etc/fstab</code></p>

<table border="1" cellpadding="0" cellspacing="0">
<tr>
    <td>defaults</td>
    <td>использование опций монтирования по-умолчанию:rw, suid, dev, exec, auto, nouser, async</td>
</tr>
<tr>
    <td>auto</td>
    <td>автоматически монтировать файловую систему при загрузке</td>
</tr>
<tr>
    <td>noauto</td>
    <td>не монтировать файловую систему автоматически</td>
</tr>
<tr>
    <td>ro</td>
    <td>монтировать только для чтения</td>
</tr>
<tr>
    <td>rw</td>
    <td>монтировать для чтения и записи</td>
</tr>
<tr>
    <td>sw</td>
    <td>монтировать раздел подкачки</td>
</tr>
<tr>
    <td>atime</td>
    <td>изменять параметр &laquo;время доступа при обращении к файлам (по умолчанию)&raquo;</td>
</tr>
<tr>
    <td>relatime</td>
    <td>изменять параметр &laquo;время доступа&raquo; только для записи для улучшения производительности</td>
</tr>
<tr>
    <td>noatime</td>
    <td>никогда не изменять &laquo;время доступа&raquo; для наилучшей производительности</td>
</tr>
<tr>
    <td>sync</td>
    <td>весь ввод-вывод осуществляется синхронно</td>
</tr>
<tr>
    <td>async</td>
    <td>весь ввод-вывод осуществляется асинхронно</td>
</tr>
<tr>
    <td>exec</td>
    <td>система может содержать исполняемые файлы</td>
</tr>
<tr>
    <td>noexec</td>
    <td>запретить исполняемые файлы</td>
</tr>
<tr>
    <td>suid</td>
    <td>разрешить интерпритацию битов SUID и SGID</td>
</tr>
<tr>
    <td>nosuid</td>
    <td>не разрешать интерпретацию битов SUID и SGID</td>
</tr>
<tr>
    <td>user</td>
    <td>разрешить обычному пользователь (не обладающему правами root) монтировать и размонтировать данную файловую систему</td>
</tr>
<tr>
    <td>users</td>
    <td>разрешить каждому пользователю монтировать данную ФС</td>
</tr>
<tr>
    <td>nouser</td>
    <td>монтирование разрешено только пользователю root</td>
</tr>
</table>

<p>----- Немного примеров -----</p>

<p>Монтирование iso-образа (образ диска):</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> mkdir /mnt/iso
<span class="gp">#</span> mount -t iso9660 image.iso /mnt/iso
</code></pre></div>
<p>В примере сначала был создан каталог для монтирования, затем подмонтирован образ диска с указанием его файловой системы (<code>iso9660</code>), именем (<code>image.iso</code>), точкой монирования (<code>/mnt/iso</code>). Впрочем, сейчас в большинстве случаев файловая система устройства распознаётся автоматически.</p>

<p>Если один и тот же накопитель должен быть смонтирован и доступен всегда, можно внести соответствующую запись в <code>/etc/fstab</code>:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="c"># /etc/fstab</span>
<span class="nv">UUID</span><span class="o">=</span><span class="s2">&quot;339df6e7-91a8-4cf9-a43f-7f7b3db533c6&quot;</span>   /   ext4   defaults   0   1
/dev/sda1  /mnt/ntfs  ntfs  ro,auto,utf8  0 0
</code></pre></div>
<p>Монтировать можно как по UUID, так и с обычным указанием раздела, или даже назначить разделу метку и монтировать по ней.  В первом примере — с UUID — файловая система подмонтирована в корневой раздел, тип файловой системы etx4. Во втором примере подмонтирован раздел с ntfs в режиме только для чтения, с монтированием в каталог <code>/mnt/ntfs</code> при загрузке системы, указанием кодировки для корректного отображения имён файлов и каталогов. Но к ntfs мы ещё вернёмся чуть позже.</p>

<p>Чтобы узнать UUID раздела используйте команду <code>blkid</code>:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> blkid
<span class="go">/dev/sda1: UUID=&quot;C474B30B74B2FEEC&quot; TYPE=&quot;ntfs&quot;</span>
<span class="go">/dev/sda2: UUID=&quot;723c0ce1-d6f2-4272-a6fb-0c83b307d5b3&quot; TYPE=&quot;ext2&quot;</span>
<span class="go">/dev/sda3: UUID=&quot;1cd73487-d108-46d5-85a1-9e1be4731d08&quot; TYPE=&quot;ext4&quot;</span>
<span class="go">/dev/sda5: UUID=&quot;665079e7-1e34-41b5-b66b-93c480bb8c93&quot; TYPE=&quot;ext4&quot;</span>
</code></pre></div>
<h2 id="toc_2">Добавление пользователя в нужную группу</h2>

<p>Группы в различных дистрибутивах linux могут отличаться своим наименованием. Если вы не нашли указанную здесь группу, ищите подобную ей. Список всех групп можно увидеть, открыв файл <code>/etc/group</code>:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> cat /etc/group
<span class="go">disk:x:6:root,adm</span>
<span class="go">lp:x:7:lp</span>
<span class="go">mem:x:8:</span>
<span class="go">wheel:x:10:root,newbie</span>
<span class="go">floppy:x:11:root</span>
<span class="go">audio:x:18:newbie</span>
<span class="go">cdrom:x:19:newbie</span>
<span class="go">video:x:27:root,newbie</span>
</code></pre></div>
<p>Чтобы добавить пользователя в нужную группу, скомандуйте:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> gpasswd -a &lt;username&gt; &lt;group&gt;
</code></pre></div>
<p>где username  —  имя вашего пользователя</p>

<p><code>group</code>  —  наименование группы, в которой должен состоять пользователь</p>

<p>Например:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> gpasswd -a newbie wheel,storage,users
</code></pre></div>
<p><code>wheel</code>  —  группа администраторов (ей мы будем давать права на монтирование)</p>

<p><code>storage</code> — доступ к съёмным накопителям. Эта группа есть в archlinux, в gentoo таковой не имеется, зато есть группа plugdev.</p>

<p><code>users</code>  —  обычный пользователь</p>

<p>Таким образом, можно разрешить монтирование либо пользователям с административными привилегиями, либо только пользователям, входящим в группу storage (директору и бухгалтеру можно, остальным как всегда), либо всем пользователям со стандартным набором прав.</p>

<h2 id="toc_3">Монтирование локальных дисков</h2>

<p>Предположим, что мы не с гор спустились и используем для повседневных задач графический интерфейс — GUI. Открываем файловый менеджер, подключаем съёмное устройство, будь то флешка, внешний жёсткий диск или телефон. Кликаем мышью на указанное устройство, долго-долго томимся в ожидании чуда и — наконец! — получаем ответ: <code>Not authorized</code>. После чего приходит понимание, что комфорт нам только снится. Что делать? У нас есть несколько путей.</p>

<p><b>/etc/fstab</b></p>

<p>Классика жанра: монтирование разделов посредством правки <code>/etc/fstab</code>. Пример:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">/dev/cdrom    /mnt/cdrom      iso9660  noauto,user,mode=0444   0 0
/dev/sdb1     /mnt/usbflash   vfat     fmask=113,noauto,user,utf8=1
</code></pre></div>
<p>В данном примере предполагается использование файловой системы <code>iso9669</code> для дисковода, <code>vfat</code> (FAT32) для съёмного накопителя. Команду и опции монтирования в случае с файловым менеджером spacefm можно легко настроить.</p>

<p><b>Правила монтирования</b></p>

<p>Ниже приводится два независимых правила, использование которых по прямому назначению должно быть разграничено. То есть либо первое правило, либо второе. Первый пример отлично работает у вашей покорной слуги: монтирует внешние накопители, логические диски и корректно опознает когда к нему подключен телефон (что само собой разумеется, ибо подключение также производится в режиме внешнего накопителя).
Итак, раз и навсегда настроим права для монтирования, написав правило для <code>polkit</code>.</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="c"># /etc/polkit-1/rules.d/10-udisks2.rules</span>

polkit.addRule<span class="o">(</span><span class="k">function</span><span class="o">(</span>action, subject<span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span>action.id <span class="o">==</span> <span class="s2">&quot;org.freedesktop.udisks2.filesystem-mount-system&quot;</span> <span class="o">||</span>
        action.id <span class="o">==</span> <span class="s2">&quot;org.freedesktop.udisks2.filesystem-mount&quot;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> subject.isInGroup<span class="o">(</span><span class="s2">&quot;wheel&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return </span>polkit.Result.YES;
    <span class="o">}</span>
<span class="o">})</span>;

polkit.addRule<span class="o">(</span><span class="k">function</span><span class="o">(</span>action, subject<span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span>action.id <span class="o">==</span> <span class="s2">&quot;org.freedesktop.udisks.filesystem-mount&quot;</span> <span class="o">||</span>

    action.id <span class="o">==</span> <span class="s2">&quot;org.freedesktop.udisks.filesystem-mount-system-internal&quot;</span><span class="o">)</span>
    <span class="o">&amp;&amp;</span> subject.isInGroup<span class="o">(</span><span class="s2">&quot;wheel&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return </span>polkit.Result.YES;
    <span class="o">}</span>
<span class="o">})</span>;
</code></pre></div>
<p>Данное выше, вполне себе рабочее правило, по утверждению линуксоида-старожила <code>@zagrei</code> должно быть заменено на иное. За работу последнего не ручаюсь, но, доверяя товарищу по ОС, который дурного не посоветует, привожу здесь. Выглядит оно куда более изящно (надо полагать ввиду отсутствия xml):</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="c"># /etc/polkit-1/localauthority/50-local.d/10-local-udisks.pkla</span>

<span class="o">[</span>Mount Permissions <span class="k">for </span>users<span class="o">]</span>
<span class="nv">Identity</span><span class="o">=</span>unix-group:users
<span class="nv">Action</span><span class="o">=</span>org.freedesktop.udisks.filesystem-mount
<span class="nv">ResultAny</span><span class="o">=</span>auth_self

<span class="o">[</span>Eject Permissions <span class="k">for </span>users<span class="o">]</span>
<span class="nv">Identity</span><span class="o">=</span>unix-group:users
<span class="nv">Action</span><span class="o">=</span>org.freedesktop.udisks.drive-eject
<span class="nv">ResultAny</span><span class="o">=</span>auth_self
</code></pre></div>
<p><b>UAM+PMOUNT</b></p>

<p>Другой способ заключается в использовании <code>uam</code> + <code>pmount</code>. Желающие пойти по этому пути должны установить указанные пакеты и добавить пользователя в соответствующую группу:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> emerge -av uam
<span class="gp">#</span> gpasswd -a newbie plugdev
<span class="gp">#</span> emerge -av pmount
</code></pre></div>
<p>Дабы корректно отображалась кириллица при монтировании NTFS-разделов, нужно немного видоизменить настройки в файле <code>/etc/udev/uam.conf</code>:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">MOUNT_OPTS=&#39;noatime,utf8&#39;
</code></pre></div>
<h2 id="toc_4">Монтирование сетевых дисков</h2>

<p>Для монтирования каталогов с ftp-сервера потребуется установить уже упомянутую curlftpfs, после чего монтирование в консоли сводится к нехитрым телодвижениям:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">$</span> curlftpfs ftp://mirror.yandex.ru/gentoo-distfiles/ public_html
</code></pre></div>
<p>где public_html — каталог в домашней директории пользователя, а по совместительству точка монтирования</p>

<p>Отмонтировать:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">$</span> fusermount -u public_html
</code></pre></div>
<p><a href="http://2.bp.blogspot.com/-V5znTT7Hpro/UVfnTnYCmYI/AAAAAAAAEQ4/UfqnwgrQBn0/s1600/curlftp.png" data-lighter><img src="http://2.bp.blogspot.com/-V5znTT7Hpro/UVfnTnYCmYI/AAAAAAAAEQ4/UfqnwgrQBn0/s1600/curlftp.png"/></a></p>

<p>Для монтирования каталогов удалённого хоста через SSH:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> sshfs <span class="o">[</span>user@<span class="o">]</span>host:<span class="o">[</span>dir<span class="o">]</span> mountpoint
</code></pre></div>
<p>Чтобы смонтировать от непривилегированного пользователя:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> sshfs <span class="o">[</span>user@<span class="o">]</span>host:<span class="o">[</span>dir<span class="o">]</span> mountpoint -o allow_other
</code></pre></div>
<p>Разумеется, мы и файловый менеджер можем научить монтировать удалённые каталоги. Хотя по сравнению с консолью быстротой своих действий он похвастаться не сможет. Напоминается, что для этого нужен установленный <code>udevil</code>, настройки которого мы и пойдём править в <code>/etc/udevil/udevil.conf</code>. Перед правкой рекомендуется сохранить данный файл с другим именем на случай, если что-то пойдёт не так, как нами запланировано. Сделаем это:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> cp /etc/udevil/udevil.conf /etc/udevil/udevil-newbie.conf
<span class="gp">#</span> vim /etc/udev/udevil.conf:
<span class="go">allowed_types = curlftpfs, ftpfs  # разрешённые файловые системы</span>
<span class="go">allowed_media_dirs = /media, /run/media/$USER # куда монтировать</span>
<span class="go">allowed_users = *                 # разрешение для отдельных пользователей - нет</span>
<span class="go">allowed_groups = *                # разрешение на монтирование для отдельных групп — нет</span>
</code></pre></div>
<p>В такой конфигурации пользователь должен быть добавлен в группу <code>storage</code> или <code>plugdev</code>. При необходимости можно указать любую из возможных файловых систем: cifs, smbfs, nfs, curlftpfs, ftpfs, sshfs, tmpfs, ramfs.</p>

<h2 id="toc_5">Что делать с NTFS?</h2>

<p>Здесь есть два варианта: включить поддержку ntfs в ядре или поставить пакет <code>ntfs3g</code>. Для первого случая конфигурация будет такой:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">File Systems ---&gt;
    DOS/FAT/NT Filesystems  ---&gt;
    &lt;M&gt; MSDOS fs support
    &lt;M&gt; VFAT (Windows-95) fs support
    &lt;M&gt; NTFS file system support
</code></pre></div>
<p>Во втором (рекомендуемом) случае достаточно поставить указанный выше пакет и дать пользователю права на монтирование. Если есть надобность, смонтировать вручную:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> mkdir /mnt/hdd
<span class="gp">#</span> mount -t ntfs /dev/sda1 /mnt/hdd
</code></pre></div>
<p><em>Примечание:</em> flash-накопители, используемые для хранения данных, можно отформатировать в exFAT. Windows, начиная с Win Seven, будет понимать и радостно принимать проприетарную файловую систему от разработчиков из Редмонда. Для корректной работы в UNIX-системах следует установить пакет <code>fuse-exfat</code>. ФС будет доступна как для чтения, так и для записи.</p>

<p>Для разделов, отформатированных в FAT32 указать тип <code>vfat</code>:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> mount -t vfat /dev/sda1 /mnt/hdd
</code></pre></div>
<p>Для MS-DOS аналогично:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="gp">#</span> mount -t msdos /dev/sda1 /mnt/hdd
</code></pre></div>
<p>Если в <code>rules.d</code> заданы права на монтирование, можно будет открывать и диски с ntfs в файловом менеджере.</p>

<h2 id="toc_6">Литература для любопытных</h2>

<ul>
<li><a href="http://www.freedesktop.org/software/polkit/docs/latest/index.html">polkit Reference Manual</a></li>
<li><a href="http://udisks.freedesktop.org/docs/latest/">UDisks Reference Manual</a></li>
<li><a href="http://igurublog.wordpress.com/downloads/script-devmon/">devmon</a></li>
</ul>


<br />
<p align="center"><a href="#">наверх</a></p>


</div>
</div>
<div id="footer-wrapper">
<ul class="footer">
   <a href="/tags/android.html" class="set-1">android</a> <a href="/tags/arch.html" class="set-3">arch</a> <a href="/tags/blog.html" class="set-1">blog</a> <a href="/tags/debian.html" class="set-1">debian</a> <a href="/tags/decorations.html" class="set-1">decorations</a> <a href="/tags/editors.html" class="set-1">editors</a> <a href="/tags/gentoo.html" class="set-1">gentoo</a> <a href="/tags/git.html" class="set-1">git</a> <a href="/tags/kernel.html" class="set-1">kernel</a> <a href="/tags/latex.html" class="set-1">latex</a> <a href="/tags/linux.html" class="set-5">linux</a> <a href="/tags/python.html" class="set-2">python</a> <a href="/tags/ruby.html" class="set-1">ruby</a> <a href="/tags/server.html" class="set-2">server</a> <a href="/tags/web.html" class="set-1">web</a> <a href="/tags/windows.html" class="set-1">windows</a>
</ul>
<ul class="footer">
    <li class="footer">&copy;&nbsp;2011&mdash;2013&nbsp;::</li>
    <li class="footer"><a href="/">unix-lab.org</a>&nbsp;::</li>
    <li class="footer">licensed under <a href="http://creativecommons.org/licenses/by-nc/3.0/deed.ru">CC BY-NC</a></li>
</ul>
</div>

</body>
</html>
