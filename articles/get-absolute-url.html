<!DOCTYPE html>
<html lang="ru">
<head>
  <title>Абсолютные пути URL в Django</title>
  <meta charset="utf-8">
  <meta name="description" content="Как получить полный путь URL-страницы в Django">  <meta name="author" content="redVi">  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
  <link href="http://www.unix-lab.org/theme/css/screen.css" rel="stylesheet" type="text/css" />
  <meta name='yandex-verification' content='494a81ecb0e796d6' />
  <link rel="icon" href="http://www.unix-lab.org/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="http://www.unix-lab.org/favicon.ico" type="image/x-icon">
  <link href="http://www.unix-lab.org/" type="application/atom+xml" rel="alternate" title="unix-lab.org ATOM Feed" />
  <link href="http://www.unix-lab.org/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="unix-lab.org RSS Feed" />
</head>
<body>
<div id="outer-wrapper">
<div id="header-wrapper">
    <a href="http://www.unix-lab.org"><div class="logo"></div></a>
    <div class="small">блог об операционных системах, open source и программировании</div>
<div class="nav">
        <ul>
      <li><a href="http://www.unix-lab.org/archives.html">Архив</a></li>
      <li><a href="http://www.unix-lab.org/about.html">О блоге</a></li>
      <li><a href="http://www.unix-lab.org/authors.html">Экипаж</a></li>
    </ul>
</div>
</div>    <div id="main">
<h2><a href="http://www.unix-lab.org/articles/get-absolute-url.html">Абсолютные пути URL в Django</a></h2>
<h5><i class="icon-feather"></i> 03 Октябрь 2013 </h5>
<p>В одной из <a href="http://www.unix-lab.org/articles/django-first-steps.html">предыдущих заметок</a>, нами был написан шаблон для вывода списка публикаций на главной странице. Ссылка на полный текст публикации имеет вид <code>{% url 'articles:detail' post.id %}</code>, что позволяет получить определённую страницу по её идентификатору (<code>id</code>). За отображение страницы ответственность несёт представление <code>articles</code> из пространства имён (<code>namespace</code>) <code>detail</code>. В данном ниже примере для разнообразия используем другую модель, а также для упрощения понимания материала откажемся от использования пространств имён: одно приложение &mdash; одна модель &mdash; один urls.py.</p>
<p>И всё бы хорошо, но ссылки подобного вида иногда могут не подойти вам. Вот пара простых примеров, иллюстрирующих этот тезис:</p>
<ul>
<li>Вам нужно получить статью по slug</li>
<li>Вам нужно отобразить ссылки на предыдущую и следующую статью</li>
</ul>
<p>Что же, разберём указанные примеры по-порядку.</p>
<h3>Вид urls.py</h3>
<p>Создание файла <code>urls.py</code>, отвечающего нашим запросам. Отображено использование обобщённых представлений, подробности о которых вы без труда найдёте в документации.</p>
<p>У нас имеется представление <code>IndexView</code>, на которое возложен вывод индексной страницы со списком последних публикаций, а также <code>DetailView</code>, которое выводит отдельную запись. В шаблоне к ним можно обращаться как к <code>latest_articles_list</code> и <code>detail</code> соответственно.</p>
<div class="highlight"><pre><span class="c"># urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">IndexView</span><span class="p">,</span> <span class="n">DetailView</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">IndexView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;latest_articles_list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^articles/(?P&lt;slug&gt;[-\w]+)/$&#39;</span><span class="p">,</span> <span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;article.html&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;detail&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>


<h3>Обращение по первичному ключу</h3>
<p>В случае, когда нужно получить объект по <code>slug</code>, нам важно знать, что любая модель имеет свой первичный ключ (<code>primary key</code>) и его можно переопределить. По-умолчанию первичным ключом является поле <code>id</code>, генерируемое автоматически. Таким образом, мы получаем URL вида:</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//site.org/articles/1/</span>
<span class="nl">http:</span><span class="c1">//site.org/articles/2/</span>
</pre></div>


<p>А хотим видеть такие адреса:</p>
<div class="highlight"><pre><span class="nl">http:</span><span class="c1">//site.org/articles/krasivyi-url/</span>
<span class="nl">http:</span><span class="c1">//site.org/articles/po-poly-slug/</span>
</pre></div>


<p>Самым простым решением является переопределение первичного ключа, но в этом случае вы больше не сможете обращаться к полю модели по <code>id</code>.</p>
<div class="highlight"><pre><span class="c"># models.py</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Create Post &#39;&#39;&#39;</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;Title&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;Create Date&#39;</span><span class="p">)</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;Last Update&#39;</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;Author&#39;</span><span class="p">)</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s">&#39;Meta Description&#39;</span><span class="p">)</span>
</pre></div>


<p>Как мог заметить наблюдательный читатель, мы задали поле <code>slug</code> со значением <code>primary_key=True</code>. Предполагается, что в этом поле будет установлен устраивающий автора красивый URL. Теперь следует ссылаться на детальное представление публикации именно по этому полю. Конкретный пример будет приведён чуть ниже.</p>
<p><strong>Примечание</strong>: если при создании представления вы используете обобщённые представления, вернуть публикацию по полю <code>slug</code>, не нагромождая ваше представление и не затрагивая <code>primary key</code>, также может быть очень легко. В этом вам посодействуют <code>DetailView</code> и <code>get_object_or_404</code>:</p>
<div class="highlight"><pre><span class="cp"># views.py</span>

<span class="n">from</span> <span class="n">django</span><span class="p">.</span><span class="n">shortcuts</span> <span class="n">import</span> <span class="n">get_object_or_404</span>
<span class="n">from</span> <span class="n">django</span><span class="p">.</span><span class="n">views</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">detail</span> <span class="n">import</span> <span class="n">DetailView</span>

<span class="n">class</span> <span class="n">DetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot; Return detail data &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">article</span><span class="err">&#39;</span>

    <span class="n">def</span> <span class="n">get_object</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="n">slug__iexact</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">kwargs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">slug</span><span class="err">&#39;</span><span class="p">])</span>
</pre></div>


<p>Прежде, чем приступить к написанию шаблонов, решим второй вопрос: о получении абсолютных путей к объекту.</p>
<h3>Абсолютные пути</h3>
<p>Итак, для примера мы решили, что будем выводить предыдущую и следующую статью при обращении к статье текущей. Если просто обращаться к статье по указанному ключу, можно поиметь некоторые проблемы. Наш URL имеет относительный путь, поэтому при наведении на любую ссылку внутри поста, которая сформирована также (то есть с указанием <code>{% url 'view' object.slug %}</code>), первичный ключ выбранной статьи просто будет добавлен к уже имеющемуся адресу. Вот так:</p>
<div class="highlight"><pre><span class="err">имеем</span><span class="o">:</span>
<span class="nl">http:</span><span class="c1">//site.org/articles/my-article</span>
<span class="err">при</span> <span class="err">наведении</span> <span class="err">на</span> <span class="err">другую</span> <span class="err">ссылку</span> <span class="err">получим</span><span class="o">:</span>
<span class="nl">http:</span><span class="c1">//site.org/articles/my-article/my-next-article</span>
</pre></div>


<p>Поэтому мы добавим к нужной модели спасательный круг в виде метода <code>get_absolute_url</code> и сразу же выведем в шаблоне именно то, что нужно.</p>
<div class="highlight"><pre><span class="c"># models.py</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>


<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;Title&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s">&#39;detail&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">)])</span>
</pre></div>


<h3>Подготовка шаблонов</h3>
<p>Теперь в шаблонах мы можем ссылаться на статью по её абсолютному адресу, используя <code>get_absolute_url</code>. Примеры:</p>
<p>подобным образом может выглядеть индексная страница со списком последних публикаций</p>
<div class="highlight"><pre><span class="c">&lt;!--index.html--&gt;</span>
{% extends &quot;base.html&quot; %}
{% block content %}
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
    {% for article in latest_articles_list %}
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ article.get_absolute_url }}&quot;</span><span class="nt">&gt;</span>{{ article.title }}<span class="nt">&lt;/a&gt;</span>
    {% endfor %}
<span class="nt">&lt;/div&gt;</span>
{% endblock content %}
</pre></div>


<p>а на странице детального представления можно добавить ссылки на предыдущий и следующий пост</p>
<div class="highlight"><pre><span class="c">&lt;!--article.html--&gt;</span>
{% extends &quot;base.html&quot; %}
{% block content %}
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ article.get_absolute_url }}&quot;</span><span class="nt">&gt;</span>{{ article.title }}<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
{{ article.content }}
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;links&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ article.get_next_by_pub_date.get_absolute_url }}&quot;</span><span class="nt">&gt;</span>Next<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>on top<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ article.get_previous_by_pub_date.get_absolute_url }}&quot;</span><span class="nt">&gt;</span>Prev<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
{% endblock %}
</pre></div>


<p><code>Model.get_next_by_pub_date</code> вернёт следующую публикацию, основываясь на дате её создания</p>
<p><code>Model.get_previous_by_pub_date</code> отобразит предыдущую публикацию.</p>
<p>Применив к ним метод <code>get_absolute_url</code>, мы получим искомое решение.</p>
<h5><i class="icon-user"></i> <a href="http://www.unix-lab.org/author/redvi.html">redVi</a>,
<i class="icon-bookmarks"></i> <a href="http://www.unix-lab.org/tag/django.html">Django</a> /
</h5>
<p align="center"><a href="#">наверх</a></p>
</div>
</div>
<div id="footer-wrapper">
<ul class="footer">
       <li class="footer"><a href="http://www.unix-lab.org/tag/android.html">Android&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/arch.html">Arch&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/blog.html">Blog&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/debian.html">Debian&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/decorations.html">Decorations&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/django.html">Django&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/editors.html">Editors&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/gentoo.html">Gentoo&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/git.html">Git&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/javascript.html">JavaScript&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/kernel.html">Kernel&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/latex.html">LaTeX&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/linux.html">Linux&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/python.html">Python&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/server.html">Server&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/web.html">Web&nbsp;&bull;</a></li>
       <li class="footer"><a href="http://www.unix-lab.org/tag/windows.html">Windows&nbsp;&bull;</a></li>
  </ul><ul class="footer">
    <li class="footer">&copy;&nbsp;2011&mdash;2013&nbsp;::</li>
    <li class="footer"><a href="http://www.unix-lab.org">unix-lab.org </a>&nbsp;::</li>
    <li class="footer">powered by <a href="https://github.com/getpelican">pelican</a>&nbsp;::</li>
    <li class="footer"><a href="http://creativecommons.org/licenses/by-nc/3.0/deed.ru">CC BY-NC</a></li>
</ul>
</div><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42400517-1', 'www.unix-lab.org');
  ga('send', 'pageview');

</script>
</body>
</html>